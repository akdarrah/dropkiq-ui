"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const constants_1=require("./constants"),DataSchema_1=require("./DataSchema"),CaretTagFinder_1=require("./CaretTagFinder"),Authorizer_1=require("./Authorizer"),OutputAnalyzer_1=require("./OutputAnalyzer"),liquid_options_1=require("./liquidjs/src/liquid-options"),tokenizer_1=require("./liquidjs/src/parser/tokenizer"),liquid_1=require("./liquidjs/src/liquid"),parser_1=require("./liquidjs/src/parser/parser"),render_1=require("./liquidjs/src/render/render"),error_1=require("./liquidjs/src/util/error");class DropkiqEngine{constructor(e,t,i,r,s,a=""){if(this.opts={},this.options=liquid_options_1.applyDefault(liquid_options_1.normalize(this.opts)),this.liquid=new liquid_1.Liquid(this.opts),this.tokenizer=new tokenizer_1.Tokenizer(this.options),this.parser=new parser_1.default(this.liquid),this.renderer=new render_1.Render,!i)throw new Error("Dropkiq schema is empty. Please double check you're loading the dropkiq_schema.yaml file correctly.");0===Object.keys(i).length&&console.log("WARNING: Dropkiq schema object is empty."),this.schema=i,this.context=r,this.scope=s,this.licenseKey=a,this.result={},this.dataSchema=new DataSchema_1.DataSchema(i,r,s),this.authorizer=new Authorizer_1.Authorizer(this.licenseKey),this.authorizer.authorize(),this.setTextBodyAndCaretPositionWithUpdate(e,t)}update(e,t){return this.setTextBodyAndCaretPositionWithUpdate(e,t)}setTextBodyAndCaretPositionWithUpdate(e,t){this.rawTextBody=e,this.caretIndex=t,this.setRowAndColumnFromIndex();try{this.tokens=this.tokenizer.tokenize(this.rawTextBody)}catch(e){if(this.state=constants_1.ERROR,e instanceof error_1.TokenizationError)return{message:"Liquid is invalid (possibly because of unmatched {{ or {% braces)"};throw e}return this.caretTagFinder=new CaretTagFinder_1.CaretTagFinder(this.tokens,this.caretRow,this.caretColumn),this.state=this.caretTagFinder.findState(),this.caretToken=this.caretTagFinder.findCaretToken(),this.caretLiquidPosition=this.caretTagFinder.findCaretLiquidPosition(),this.findResult()}findResult(){if(!this.caretToken)return this.result={};switch(this.state){case constants_1.HTML:case constants_1.TAG:this.result={};break;case constants_1.OUTPUT:{this.templates=this.parser.parse(this.tokens);let e=new OutputAnalyzer_1.OutputAnalyzer(this.templates,this.caretToken,this.caretLiquidPosition,this.dataSchema,this.authorizer);this.result=e.analyze();break}default:throw new Error(`Unknown Dropkiq state "${this.state}"`)}return this.result}setRowAndColumnFromIndex(){this.rawLeftTextBody=this.rawTextBody.slice(0,this.caretIndex),this.rawRightTextBody=this.rawTextBody.slice(this.caretIndex,this.rawTextBody.length);let e=this.rawLeftTextBody.split(/\r?\n/g);var t=e.length-1,i=e[t].length;this.caretRow=t,this.caretColumn=i}}exports.DropkiqEngine=DropkiqEngine;