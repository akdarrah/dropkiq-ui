"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const ScopeCapture_1=require("./ScopeCapture"),LivePreviewer_1=require("./LivePreviewer");class OutputAnalyzer{constructor(e,t,s,i,r,a=(()=>{})){this.templates=e,this.caretToken=t,this.caretLiquidPosition=s,this.dataSchema=i,this.authorizer=r,this.suggestionFilter=a,this.rawText=this.caretToken.raw,this.leftCaretText=this.rawText.slice(0,this.caretLiquidPosition),this.rightCaretText=this.rawText.slice(this.caretLiquidPosition,this.rawText.length)}analyze(){let e={preview:"",suggestions:[],prefix:""},t=new ScopeCapture_1.ScopeCapture([...this.templates],this.caretToken,this.dataSchema);t.capture(this.dataSchema.scope);let s=t.getCapturedRendered();if(s&&(e.preview=s),this.canMakeSuggestion()){let t=this.getPathFromRawText(),s=t.pop(),i=[];this.dataSchema.setCurrentPath(t);let r=this.getContextWithScopeOptions();this.dataSchema.buildPathSchema(i,r);let a,n=i[i.length-1];if(n&&"ColumnTypes::HasOne"!==n.type)throw new Error("End of Liquid expression reached");if(n&&!this.authorizer.authorized()){let e=this.dataSchema.nextOptions(i,r);a={dropkiq:{type:"ColumnTypes::String",foreign_table_name:null,hint:`${Object.keys(e).length} ${n.name} Liquid methods are hidden in the free version of Dropkiq.`}}}else a=this.dataSchema.nextOptions(i,r);a=a||{},s&&(a=this.filterResults(s,a)),this.livePreviewer=new LivePreviewer_1.LivePreviewer(t,a,this.templates,this.caretToken,this.dataSchema),a=this.livePreviewer.suggestionsWithPreviews(),e.pathSchema=i,e.prefix=s||"",e.suggestions=a||{},e.suggestionsArray=Object.keys(e.suggestions).map(t=>{let i=e.suggestions[t];return Object.assign({},i,{name:t,prefix:s,nameWithoutPrefix:this.nameWithoutPrefix(t,e.prefix),iconImageURLForSuggestion:this.iconImageURLForSuggestion(i.type)})}),this.suggestionFilter(e.suggestionsArray)}else if(this.canMakeFilterSuggestion()&&this.authorizer.authorized()){let t=this.getFilterPrefix(),s=this.dataSchema.filterRegistry.registry;t&&(s=this.filterResults(t,s)),e.pathSchema=[],e.prefix=t||"",e.suggestions=s||{},e.suggestionsArray=Object.keys(e.suggestions).map(s=>{let i=e.suggestions[s];return Object.assign({},i,{name:s,prefix:t,nameWithoutPrefix:this.nameWithoutPrefix(s,e.prefix),iconImageURLForSuggestion:this.iconImageURLForSuggestion(i.type),template:i.template,selectRange:i.selectRange})})}return e}canMakeSuggestion(){return!this.cursorIsInBraces()&&this.cursorIsLeftOfFilters()&&this.pastRightMostPeriod()&&!this.spaceExistsAfterContent()&&this.rightCharacterIsEligible()}canMakeFilterSuggestion(){return!this.cursorIsInBraces()&&this.cursorIsRightOfFilters()&&!this.spaceOrColonExistsAfterContent()&&this.rightCharacterIsEligible()}cursorIsInBraces(){return!this.leftCaretText.includes("{{")||!this.rightCaretText.includes("}}")}cursorIsLeftOfFilters(){return!this.leftCaretText.includes("|")}cursorIsRightOfFilters(){return!this.cursorIsLeftOfFilters()}pastRightMostPeriod(){return!this.rightCaretText.includes(".")}rightCharacterIsEligible(){let e=this.rightCaretText[0];return" "===e||e==String.fromCharCode(160)||"|"===e||"}"===e}spaceExistsAfterContent(){let e=this.leftCaretText.replace(/\{+/,"");return new RegExp(/\S+\s+/).test(e)}spaceOrColonExistsAfterContent(){let e=this.leftCaretText.replace(/\{+.*\|/,"");return new RegExp(/(\s+)?\S+(\s+|\:)/).test(e)}getFilterPrefix(){let e=this.leftCaretText.replace(/\{+.*\|/,""),t=new RegExp(/\s+?(\S+)/),s=e.match(t);return s?s[1]:""}getPathFromRawText(){let e=this.rawText.replace("{{","").replace("}}","").split("|")[0].trim();return 0===e.length?[]:e.split(".")}filterResults(e,t){let s=Object.assign({},t);return Object.keys(s).forEach(t=>{s[t];t===e&&delete s[t],t.startsWith(e)||delete s[t]}),s}getContextWithScopeOptions(){let e=new ScopeCapture_1.ScopeCapture(this.templates,this.caretToken,this.dataSchema).optionsFromScope(),t=JSON.parse(JSON.stringify(this.dataSchema.context));return this.authorizer.authorized()?Object.assign(t,e):Object.assign(t,{})}nameWithoutPrefix(e,t){return e.slice(t.length,e.length)}iconImageURLForSuggestion(e){switch(e){case"ColumnTypes::Filter":return"https://app.dropkiq.com/plugin/filter1.png";case"ColumnTypes::HasMany":return"https://app.dropkiq.com/plugin/array.png";case"ColumnTypes::HasOne":case"ColumnTypes::YAML":return"https://app.dropkiq.com/plugin/object.png";case"ColumnTypes::String":return"https://app.dropkiq.com/plugin/string.png";case"ColumnTypes::Numeric":return"https://app.dropkiq.com/plugin/numeric.png";case"ColumnTypes::Boolean":return"https://app.dropkiq.com/plugin/boolean.png";case"ColumnTypes::DateTime":return"https://app.dropkiq.com/plugin/date.png";case"ColumnTypes::Text":return"https://app.dropkiq.com/plugin/string.png"}}}exports.OutputAnalyzer=OutputAnalyzer;