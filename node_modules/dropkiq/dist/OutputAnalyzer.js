"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const ScopeCapture_1=require("./ScopeCapture"),LivePreviewer_1=require("./LivePreviewer");class OutputAnalyzer{constructor(e,t,i,s,r,a=(()=>{})){this.templates=e,this.caretToken=t,this.caretLiquidPosition=i,this.dataSchema=s,this.authorizer=r,this.suggestionFilter=a,this.rawText=this.caretToken.raw,this.leftCaretText=this.rawText.slice(0,this.caretLiquidPosition),this.rightCaretText=this.rawText.slice(this.caretLiquidPosition,this.rawText.length)}analyze(){let e={preview:"",suggestions:[],prefix:""};if(this.canMakeSuggestion()){let t=this.getPathFromRawText(),i=t.pop(),s=[];this.dataSchema.setCurrentPath(t);let r=this.getContextWithScopeOptions();this.dataSchema.buildPathSchema(s,r);let a,n=s[s.length-1];if(n&&"ColumnTypes::HasOne"!==n.type)throw new Error("End of Liquid expression reached");if(n&&!this.authorizer.authorized()){let e=this.dataSchema.nextOptions(s,r);a={dropkiq:{type:"ColumnTypes::String",foreign_table_name:null,hint:`${Object.keys(e).length} ${n.name} Liquid methods are hidden in the free version of Dropkiq.`}}}else a=this.dataSchema.nextOptions(s,r);a=a||{},i&&(a=this.filterResults(i,a)),this.livePreviewer=new LivePreviewer_1.LivePreviewer(t,a,this.templates,this.caretToken,this.dataSchema),a=this.livePreviewer.suggestionsWithPreviews(),this.suggestionFilter(a),e.pathSchema=s,e.prefix=i||"",e.suggestions=a||{},e.suggestionsArray=Object.keys(e.suggestions).map(t=>{let s=e.suggestions[t];return Object.assign({},s,{name:t,prefix:i,nameWithoutPrefix:this.nameWithoutPrefix(t,e.prefix),iconImageURLForSuggestion:this.iconImageURLForSuggestion(s.type)})})}return e}canMakeSuggestion(){return!this.cursorIsInBraces()&&this.cursorIsLeftOfFilters()&&this.pastRightMostPeriod()&&!this.spaceExistsAfterContent()&&this.rightCharacterIsEligible()}cursorIsInBraces(){return!this.leftCaretText.includes("{{")||!this.rightCaretText.includes("}}")}cursorIsLeftOfFilters(){return!this.leftCaretText.includes("|")}pastRightMostPeriod(){return!this.rightCaretText.includes(".")}rightCharacterIsEligible(){let e=this.rightCaretText[0];return" "===e||e==String.fromCharCode(160)||"|"===e||"}"===e}spaceExistsAfterContent(){let e=this.leftCaretText.replace(/\{+/,"");return new RegExp(/\S+\s+/).test(e)}getPathFromRawText(){let e=this.rawText.replace("{{","").replace("}}","").split("|")[0].trim();return 0===e.length?[]:e.split(".")}filterResults(e,t){let i=Object.assign({},t);return Object.keys(i).forEach(t=>{i[t];t===e&&delete i[t],t.startsWith(e)||delete i[t]}),i}getContextWithScopeOptions(){let e=new ScopeCapture_1.ScopeCapture(this.templates,this.caretToken,this.dataSchema).optionsFromScope(),t=JSON.parse(JSON.stringify(this.dataSchema.context));return this.authorizer.authorized()?Object.assign(t,e):Object.assign(t,{})}nameWithoutPrefix(e,t){return e.slice(t.length,e.length)}iconImageURLForSuggestion(e){switch(e){case"ColumnTypes::HasMany":return"https://app.dropkiq.com/plugin/array.png";case"ColumnTypes::HasOne":case"ColumnTypes::YAML":return"https://app.dropkiq.com/plugin/object.png";case"ColumnTypes::String":return"https://app.dropkiq.com/plugin/string.png";case"ColumnTypes::Numeric":return"https://app.dropkiq.com/plugin/numeric.png";case"ColumnTypes::Boolean":return"https://app.dropkiq.com/plugin/boolean.png";case"ColumnTypes::DateTime":return"https://app.dropkiq.com/plugin/date.png";case"ColumnTypes::Text":return"https://app.dropkiq.com/plugin/string.png"}}}exports.OutputAnalyzer=OutputAnalyzer;