"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const ScopeCapture_1=require("./ScopeCapture"),value_1=require("./liquidjs/src/template/value"),output_1=require("./liquidjs/src/template/output"),tag_1=require("./liquidjs/src/template/tag/tag"),html_1=require("./liquidjs/src/template/html");class LivePreviewer{constructor(e,t,i,s,a,r){this.path=e,this.suggestions=t,this.templates=i,this.caretToken=s,this.dataSchema=a,this.caretLiquidPosition=r,this.originalRawExpression=""+this.caretToken.raw,this.templatesWithoutHTML=[...i],this.removeHTMLFromTemplates(this.templatesWithoutHTML)}suggestionsWithPreviews(){return Object.keys(this.suggestions).forEach(e=>{let t,i=this.suggestions[e];t="ColumnTypes::Filter"===i.type?this.constructLiquidStatementForFilterSuggestion(i,e):this.constructLiquidStatementForSuggestion(i,e);let s=[...this.templatesWithoutHTML];this.modifyCaretTokenInTemplates(t,s);let a=new ScopeCapture_1.ScopeCapture(s,this.caretToken,this.dataSchema);a.capture(this.dataSchema.scope);let r=a.getCapturedRendered();i.template=this.writePreviewTemplate(s),i.preview=r}),this.suggestions}constructLiquidStatementForSuggestion(e,t){let i=(""+this.originalRawExpression).replace("{{","").replace("}}","").split("|"),s=(i.shift(),[...this.path]);s.push(t);let a=s.join(".");return i.unshift(a),i.join(" | ")}constructLiquidStatementForFilterSuggestion(e,t){let i=""+this.originalRawExpression,s=i.slice(0,this.caretLiquidPosition).replace("{{","").replace(/\|(?!.*\|).*/,""),a=i.slice(this.caretLiquidPosition,i.length).replace("}}","").replace(/.*\||\}{2}/,"");return[s,e.insertionTemplate,a].map((function(e){return e.trim()})).filter((function(e){return e.length>0})).join(" | ")}modifyCaretTokenInTemplates(e,t){for(let i=0;i<t.length;i++){let s=t[i];if(s instanceof tag_1.Tag){["increment","include","cycle","decrement","layout","tablerow","raw","comment"].includes(s.name)&&(t.splice(i,1),i--)}s instanceof output_1.Output&&(s.token===this.caretToken?(s.token.raw=`{{ ${e} }}`,s.value=new value_1.Value(e,!1)):(t.splice(i,1),i--)),this.traverseChildren(s,t=>{this.modifyCaretTokenInTemplates(e,t)})}}removeHTMLFromTemplates(e){for(let t=0;t<e.length;t++){let i=e[t];i instanceof html_1.HTML&&(e.splice(t,1),t--),this.traverseChildren(i,e=>{this.removeHTMLFromTemplates(e)})}}traverseChildren(e,t){e.impl&&e.impl.templates&&t(e.impl.templates),e.impl&&e.impl.branches&&e.impl.branches.forEach((e,i)=>{let s=i>0?`{% elsif ${e.cond} %}`:null;t(e.templates,s)}),e.impl&&e.impl.cases&&e.impl.cases.forEach(e=>{t(e.templates,`{% when ${e.val} %}`)}),e.impl&&e.impl.elseTemplates&&e.impl.elseTemplates.length>0&&t(e.impl.elseTemplates,"{% else %}")}writePreviewTemplate(e,t=""){return e.forEach((e,i)=>{if("for"===e.name){let i=e.token.raw.replace("%}"," limit:1 %}");t=t.concat(i)}else t=t.concat(e.token.raw);if(this.traverseChildren(e,(e,i)=>{i&&(t=t.concat(i)),t=this.writePreviewTemplate(e,t)}),e instanceof tag_1.Tag)switch(e.name){case"for":t=t.concat("{% endfor %}");break;case"if":t=t.concat("{% endif %}");break;case"unless":t=t.concat("{% endunless %}");break;case"capture":t=t.concat("{% endcapture %}");break;case"case":t=t.concat("{% endcase %}");break;case"assign":break;default:throw new Error(`Unhandled Tag: "${e.name}"`)}}),t}}exports.LivePreviewer=LivePreviewer;