"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const ScopeCapture_1=require("./ScopeCapture"),value_1=require("./liquidjs/src/template/value"),output_1=require("./liquidjs/src/template/output"),tag_1=require("./liquidjs/src/template/tag/tag"),html_1=require("./liquidjs/src/template/html");class LivePreviewer{constructor(e,t,s,a,i){this.path=e,this.suggestions=t,this.templates=s,this.caretToken=a,this.dataSchema=i,this.templatesWithoutHTML=[...s],this.removeHTMLFromTemplates(this.templatesWithoutHTML)}suggestionsWithPreviews(){return Object.keys(this.suggestions).forEach(e=>{let t=this.suggestions[e],s=this.constructLiquidStatementForSuggestion(e),a=[...this.templatesWithoutHTML];this.modifyCaretTokenInTemplates(s,a);let i=new ScopeCapture_1.ScopeCapture(a,this.caretToken,this.dataSchema);i.capture(this.dataSchema.scope);let r=i.getCapturedRendered();t.template=this.writePreviewTemplate(a),t.preview=r}),this.suggestions}constructLiquidStatementForSuggestion(e){let t=(""+this.caretToken.raw).replace("{{","").replace("}}","").split("|"),s=(t.shift(),[...this.path]);s.push(e);let a=s.join(".");return t.unshift(a),t.join(" | ")}modifyCaretTokenInTemplates(e,t){for(let s=0;s<t.length;s++){let a=t[s];if(a instanceof tag_1.Tag){["increment","include","cycle","decrement","layout","tablerow","raw","comment"].includes(a.name)&&(t.splice(s,1),s--)}a instanceof output_1.Output&&(a.token===this.caretToken?(a.token.raw=`{{ ${e} }}`,a.value=new value_1.Value(e,!1)):(t.splice(s,1),s--)),this.traverseChildren(a,t=>{this.modifyCaretTokenInTemplates(e,t)})}}removeHTMLFromTemplates(e){for(let t=0;t<e.length;t++){let s=e[t];s instanceof html_1.HTML&&(e.splice(t,1),t--),this.traverseChildren(s,e=>{this.removeHTMLFromTemplates(e)})}}traverseChildren(e,t){e.impl&&e.impl.templates&&t(e.impl.templates),e.impl&&e.impl.branches&&e.impl.branches.forEach((e,s)=>{let a=s>0?`{% elsif ${e.cond} %}`:null;t(e.templates,a)}),e.impl&&e.impl.cases&&e.impl.cases.forEach(e=>{t(e.templates,`{% when ${e.val} %}`)}),e.impl&&e.impl.elseTemplates&&e.impl.elseTemplates.length>0&&t(e.impl.elseTemplates,"{% else %}")}writePreviewTemplate(e,t=""){return e.forEach((e,s)=>{if("for"===e.name){let s=e.token.raw.replace("%}"," limit:1 %}");t=t.concat(s)}else t=t.concat(e.token.raw);if(this.traverseChildren(e,(e,s)=>{s&&(t=t.concat(s)),t=this.writePreviewTemplate(e,t)}),e instanceof tag_1.Tag)switch(e.name){case"for":t=t.concat("{% endfor %}");break;case"if":t=t.concat("{% endif %}");break;case"unless":t=t.concat("{% endunless %}");break;case"capture":t=t.concat("{% endcapture %}");break;case"case":t=t.concat("{% endcase %}");break;case"assign":break;default:throw new Error(`Unhandled Tag: "${e.name}"`)}}),t}}exports.LivePreviewer=LivePreviewer;