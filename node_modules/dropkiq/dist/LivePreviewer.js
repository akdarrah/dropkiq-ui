"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const ScopeCapture_1=require("./ScopeCapture"),value_1=require("./liquidjs/src/template/value"),output_1=require("./liquidjs/src/template/output"),tag_1=require("./liquidjs/src/template/tag/tag"),html_1=require("./liquidjs/src/template/html");class LivePreviewer{constructor(e,t,a,s,i){this.path=e,this.suggestions=t,this.templates=a,this.caretToken=s,this.dataSchema=i,this.templatesWithoutHTML=[...a],this.removeHTMLFromTemplates(this.templatesWithoutHTML)}suggestionsWithPreviews(){return Object.keys(this.suggestions).forEach(e=>{let t=this.suggestions[e],a=this.constructLiquidStatementForSuggestion(e),s=[...this.templatesWithoutHTML];this.modifyCaretTokenInTemplates(a,s);let i=new ScopeCapture_1.ScopeCapture(s,this.caretToken,this.dataSchema);i.capture(this.dataSchema.scope);let r=i.getCapturedRendered();t.template=this.writePreviewTemplate(s),t.preview=r}),this.suggestions}constructLiquidStatementForSuggestion(e){let t=(""+this.caretToken.raw).replace("{{","").replace("}}","").split("|"),a=(t.shift(),[...this.path]);a.push(e);let s=a.join(".");return t.unshift(s),t.join(" | ")}modifyCaretTokenInTemplates(e,t){t.forEach((a,s)=>{if(this.traverseChildren(a,t=>{this.modifyCaretTokenInTemplates(e,t)}),a instanceof tag_1.Tag){["increment","include","cycle","decrement","layout","tablerow","raw","comment"].includes(a.name)&&t.splice(s,1)}a instanceof output_1.Output&&(a.token===this.caretToken?(a.token.raw=`{{ ${e} }}`,a.value=new value_1.Value(e,!1)):t.splice(s,1))})}removeHTMLFromTemplates(e){e.forEach((t,a)=>{this.traverseChildren(t,e=>{this.removeHTMLFromTemplates(e)}),t instanceof html_1.HTML&&e.splice(a,1)})}traverseChildren(e,t){e.impl&&e.impl.templates&&t(e.impl.templates),e.impl&&e.impl.branches&&e.impl.branches.forEach((e,a)=>{let s=a>0?`{% elsif ${e.cond} %}`:null;t(e.templates,s)}),e.impl&&e.impl.cases&&e.impl.cases.forEach(e=>{t(e.templates,`{% when ${e.val} %}`)}),e.impl&&e.impl.elseTemplates&&e.impl.elseTemplates.length>0&&t(e.impl.elseTemplates,"{% else %}")}writePreviewTemplate(e,t=""){return e.forEach((e,a)=>{if("for"===e.name){let a=e.token.raw.replace("%}"," limit:1 %}");t=t.concat(a)}else t=t.concat(e.token.raw);if(this.traverseChildren(e,(e,a)=>{a&&(t=t.concat(a)),t=this.writePreviewTemplate(e,t)}),e instanceof tag_1.Tag)switch(e.name){case"for":t=t.concat("{% endfor %}");break;case"if":t=t.concat("{% endif %}");break;case"unless":t=t.concat("{% endunless %}");break;case"capture":t=t.concat("{% endcapture %}");break;case"case":t=t.concat("{% endcase %}");break;case"assign":break;default:throw new Error(`Unhandled Tag: "${e.name}"`)}}),t}}exports.LivePreviewer=LivePreviewer;