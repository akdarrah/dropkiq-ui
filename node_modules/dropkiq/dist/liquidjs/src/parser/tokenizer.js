"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const whitespace_ctrl_1=require("./whitespace-ctrl"),html_token_1=require("./html-token"),tag_token_1=require("./tag-token"),token_1=require("./token"),output_token_1=require("./output-token"),error_1=require("../util/error"),liquid_options_1=require("../liquid-options"),node_1=require("./flatten/node");var ParseState;!function(e){e[e.HTML=0]="HTML",e[e.OUTPUT=1]="OUTPUT",e[e.TAG=2]="TAG"}(ParseState||(ParseState={}));class Tokenizer{constructor(e){this.options=liquid_options_1.applyDefault(e)}tokenize(e,t){const n=[],{tagDelimiterLeft:o,tagDelimiterRight:r,outputDelimiterLeft:i,outputDelimiterRight:s}=this.options;let l=0,a=1,u=ParseState.HTML,_="",h=0,T=1,p=1;for(;l<e.length;){if("\n"===e[l]&&(a++,h=l+1),u===ParseState.HTML){if(e.substr(l,i.length)===i){_&&n.push(new html_token_1.HTMLToken(node_1.flatten(_),e,T,p,t)),_=i,T=a,p=l-h+1,l+=i.length,u=ParseState.OUTPUT;continue}if(e.substr(l,o.length)===o){_&&n.push(new html_token_1.HTMLToken(node_1.flatten(_),e,T,p,t)),_=o,T=a,p=l-h+1,l+=o.length,u=ParseState.TAG;continue}}else{if(u===ParseState.OUTPUT&&e.substr(l,s.length)===s){_+=s,n.push(new output_token_1.OutputToken(node_1.flatten(_),_.slice(i.length,-s.length),e,T,p,this.options,t)),l+=s.length,_="",T=a,p=l-h+1,u=ParseState.HTML;continue}if(e.substr(l,r.length)===r){_+=r,n.push(new tag_token_1.TagToken(node_1.flatten(_),_.slice(o.length,-r.length),e,T,p,this.options,t)),l+=r.length,_="",T=a,p=l-h+1,u=ParseState.HTML;continue}}_+=e[l++]}if(u!==ParseState.HTML){const n=u===ParseState.OUTPUT?"output":"tag",o=_.length>16?_.slice(0,13)+"...":_;throw new error_1.TokenizationError(`${n} "${o}" not closed`,new token_1.Token(node_1.flatten(_),e,T,p,t))}return _&&n.push(new html_token_1.HTMLToken(node_1.flatten(_),e,T,p,t)),whitespace_ctrl_1.whiteSpaceCtrl(n,this.options),n}}exports.Tokenizer=Tokenizer;