"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const drop_1=require("../drop/drop"),tslib_1=require("tslib"),assert_1=require("../util/assert"),liquid_options_1=require("../liquid-options"),underscore_1=require("../util/underscore");class Context{constructor(e={},r,t=!1){this.scopes=[{}],this.registers={},this.sync=t,this.opts=liquid_options_1.applyDefault(r),this.environments=e}getRegister(e,r={}){return this.registers[e]=this.registers[e]||r}setRegister(e,r){return this.registers[e]=r}getAll(){return[this.environments,...this.scopes].reduce((e,r)=>tslib_1.__assign(e,r),{})}get(e){const r=this.parseProp(e),t=this.findScope(r[0])||this.environments;return this.getFromScope(t,r)}getFromScope(e,r){return underscore_1.isArray(r)||(r=this.parseProp(r)),r.reduce((e,r)=>{if(e=readProperty(e,r),underscore_1.isNil(e)&&this.opts.strictVariables)throw new TypeError(`undefined variable: ${r}`);return e},e)}push(e){return this.scopes.push(e)}pop(){return this.scopes.pop()}front(){return this.scopes[0]}findScope(e){for(let r=this.scopes.length-1;r>=0;r--){const t=this.scopes[r];if(e in t)return t}return null}parseProp(e){e=String(e);const r=[];let t,s="",i=0;for(;i<e.length;)switch(e[i]){case"[":n();const r=e[i+1];/['"]/.test(r)?(t=e.indexOf(r,i+2),assert_1.assert(-1!==t,`unbalanced ${r}: ${e}`),s=e.slice(i+2,t),n(),i=t+2):(t=matchRightBracket(e,i+1),assert_1.assert(-1!==t,`unbalanced []: ${e}`),s=e.slice(i+1,t),/^[+-]?\d+$/.test(s)||(s=String(this.get(s))),n(),i=t+1);break;case".":n(),i++;break;default:s+=e[i++]}if(n(),!r.length)throw new TypeError(`invalid path:"${e}"`);return r;function n(){s.length&&r.push(s),s=""}}}function readProperty(e,r){return underscore_1.isNil(e)?e:(e=underscore_1.toLiquid(e))instanceof drop_1.Drop?underscore_1.isFunction(e[r])?e[r]():e.hasOwnProperty(r)?e[r]:e.liquidMethodMissing(r):"size"===r?readSize(e):"first"===r?readFirst(e):"last"===r?readLast(e):e[r]}function readFirst(e){return underscore_1.isArray(e)?e[0]:e.first}function readLast(e){return underscore_1.isArray(e)?e[e.length-1]:e.last}function readSize(e){return underscore_1.isArray(e)||underscore_1.isString(e)?e.length:e.size}function matchRightBracket(e,r){let t=1;for(let s=r;s<e.length;s++)if("["===e[s]&&t++,"]"===e[s]&&(t--,0===t))return s;return-1}exports.Context=Context,exports.readProperty=readProperty;