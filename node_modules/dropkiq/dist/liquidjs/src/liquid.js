"use strict";var __awaiter=this&&this.__awaiter||function(e,r,t,i){return new(t||(t=Promise))((function(n,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){var r;e.done?n(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(o,a)}u((i=i.apply(e,r||[])).next())}))};function __export(e){for(var r in e)exports.hasOwnProperty(r)||(exports[r]=e[r])}Object.defineProperty(exports,"__esModule",{value:!0});const context_1=require("./context/context"),node_1=require("./fs/node"),_=require("./util/underscore"),tokenizer_1=require("./parser/tokenizer"),render_1=require("./render/render"),tag_1=require("./template/tag/tag"),filter_1=require("./template/filter/filter"),parser_1=require("./parser/parser"),value_1=require("./template/value"),tags_1=require("./builtin/tags"),filters_1=require("./builtin/filters"),liquid_options_1=require("./liquid-options"),async_1=require("./util/async");__export(require("./types"));class Liquid{constructor(e={}){this.cache={},this.options=liquid_options_1.applyDefault(liquid_options_1.normalize(e)),this.parser=new parser_1.default(this),this.renderer=new render_1.Render,this.tokenizer=new tokenizer_1.Tokenizer(this.options),this.fs=e.fs||node_1.default,_.forOwn(tags_1.default,(e,r)=>this.registerTag(r,e)),_.forOwn(filters_1.default,(e,r)=>this.registerFilter(r,e))}parse(e,r){const t=this.tokenizer.tokenize(e,r);return this.parser.parse(t)}_render(e,r,t,i){const n=Object.assign(Object.assign({},this.options),liquid_options_1.normalize(t)),s=new context_1.Context(r,n,i);return this.renderer.renderTemplates(e,s)}render(e,r,t){return __awaiter(this,void 0,void 0,(function*(){return async_1.toThenable(this._render(e,r,t,!1))}))}renderSync(e,r,t){return async_1.toValue(this._render(e,r,t,!0))}_parseAndRender(e,r,t,i){const n=this.parse(e);return this._render(n,r,t,i)}parseAndRender(e,r,t){return __awaiter(this,void 0,void 0,(function*(){return async_1.toThenable(this._parseAndRender(e,r,t,!1))}))}parseAndRenderSync(e,r,t){return async_1.toValue(this._parseAndRender(e,r,t,!0))}*_parseFile(e,r,t){const i=Object.assign(Object.assign({},this.options),liquid_options_1.normalize(r)),n=i.root.map(r=>this.fs.resolve(r,e,i.extname));if(void 0!==this.fs.fallback){const r=this.fs.fallback(e);void 0!==r&&n.push(r)}for(const e of n){if(this.options.cache&&this.cache[e])return this.cache[e];if(!(t?this.fs.existsSync(e):yield this.fs.exists(e)))continue;const r=this.parse(t?this.fs.readFileSync(e):yield this.fs.readFile(e),e);return this.cache[e]=r}throw this.lookupError(e,i.root)}parseFile(e,r){return __awaiter(this,void 0,void 0,(function*(){return async_1.toThenable(this._parseFile(e,r,!1))}))}parseFileSync(e,r){return async_1.toValue(this._parseFile(e,r,!0))}renderFile(e,r,t){return __awaiter(this,void 0,void 0,(function*(){const i=yield this.parseFile(e,t);return this.render(i,r,t)}))}renderFileSync(e,r,t){const i=liquid_options_1.normalize(t),n=this.parseFileSync(e,i);return this.renderSync(n,r,t)}_evalValue(e,r){return new value_1.Value(e,this.options.strictFilters).value(r)}evalValue(e,r){return __awaiter(this,void 0,void 0,(function*(){return async_1.toThenable(this._evalValue(e,r))}))}evalValueSync(e,r){return async_1.toValue(this._evalValue(e,r))}registerFilter(e,r){return filter_1.Filter.register(e,r)}registerTag(e,r){return tag_1.Tag.register(e,r)}plugin(e){return e.call(this,Liquid)}express(){const e=this;return function(r,t,i){const n={root:[...liquid_options_1.normalizeStringArray(this.root),...e.options.root]};e.renderFile(r,t,n).then(e=>i(null,e),i)}}lookupError(e,r){const t=new Error("ENOENT");return t.message=`ENOENT: Failed to lookup "${e}" in "${r}"`,t.code="ENOENT",t}getTemplate(e,r){return __awaiter(this,void 0,void 0,(function*(){return this.parseFile(e,r)}))}getTemplateSync(e,r){return this.parseFileSync(e,r)}}exports.Liquid=Liquid;