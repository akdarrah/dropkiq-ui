"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class BoundElement{constructor(e,t,n){this.element=e,this.window=t,this.document=n,this.isContenteditable=this.element.isContentEditable,this.isCodeMirror="object"==typeof this.element.doc,this.isAceEditor="object"==typeof this.element.renderer,this.cachedOnBlurRange=null}setFocus(){if(this.isCodeMirror)this.element.focus();else if(this.isAceEditor)this.element.focus();else{let e=new Event("focus");this.element.dispatchEvent(e)}}caretPositionWithDocumentInfo(){return this.isCodeMirror?this.caretPositionWithDocumentInfoForCodeMirror():this.isAceEditor?this.caretPositionWithDocumentInfoForAceEditor():this.isContenteditable?this.caretPositionWithDocumentInfoForContenteditable():this.caretPositionWithDocumentInfoForInput()}setCaretPosition(e,t,n,i,o){let r=e-o.length;if(this.isCodeMirror){var s=this.element.getValue(),l=(h=this.getRowAndColumnForPosition(s,r)).column+t,a=h.column+n;this.element.doc.setSelection({line:h.row,ch:l},{line:h.row,ch:a})}else if(this.isAceEditor){var h;s=this.element.getValue(),l=(h=this.getRowAndColumnForPosition(s,r)).column+t,a=h.column+n;this.element.getSelection().setSelectionRange({start:{row:h.row,column:l},end:{row:h.row,column:a}},!1)}else if(this.isContenteditable){var d=this.document.createRange(),c=this.window.getSelection();d.setStart(i,t-o.length),d.setEnd(i,n-o.length),c.removeAllRanges(),c.addRange(d)}else{let e=r+t,i=r+n;this.element.setSelectionRange(e,i)}}getRowAndColumnForPosition(e,t){var n=e.slice(0,t).split(/\r?\n/),i=n.length-1;return{row:i,column:n[i].length}}getCaretPosition(){if(this.isCodeMirror){let e=this.element.cursorCoords(!0),t=this.element.display.lineDiv,n=this.window.getComputedStyle?getComputedStyle(t):t.currentStyle,i=this.element.getCursor(!0).line+1;return{top:this.element.heightAtLine(i),left:e.left+parseInt(n.borderLeftWidth)}}if(this.isAceEditor){let e=this.element.renderer.$cursorLayer.element.getElementsByClassName("ace_cursor")[0].getBoundingClientRect();return{top:e.top+e.height,left:e.left}}if(this.isContenteditable){let e=this.window.getSelection().getRangeAt(0);return this.getContentEditableCaretPosition(e.startOffset)}{let e=this.element.selectionStart;return this.getTextAreaOrInputUnderlinePosition(this.element,e,!1)}}insertTextAtCaret(e){if(this.isCodeMirror){let t=this.element.getCursor(!0);this.element.doc.replaceRange(e,t,t)}else{if(!this.isAceEditor)return this.isContenteditable?this.insertTextForContenteditable(e):this.insertTextForInput(e);{let t=this.element.getCursorPosition();this.element.session.insert(t,e)}}}setExpiringCachedOnBlurRange(e){let t=this;this.isContenteditable&&(this.cachedOnBlurRange=e,setTimeout((function(){t.cachedOnBlurRange=null}),200))}insertTextForContenteditable(e){var t,n;t=this.window.getSelection(),this.cachedOnBlurRange?(n=this.cachedOnBlurRange,this.cachedOnBlurRange=null):n=t.getRangeAt(0),n.deleteContents();var i=this.document.createTextNode(e);return n.insertNode(i),n.selectNodeContents(i),n.collapse(!1),t.removeAllRanges(),t.addRange(n),i}insertTextForInput(e){var t=this.element,n=t.scrollTop,i=t.selectionStart,o=t.value.substring(0,i),r=t.value.substring(t.selectionEnd,t.value.length);return t.value=o+e+r,i+=e.length,t.selectionStart=i,t.selectionEnd=i,t.focus(),t.scrollTop=n,t}caretPositionWithDocumentInfoForInput(){let e=this.element.selectionStart,t=this.element.value;return{leftText:t.slice(0,e),selectionStart:e,rightText:t.slice(e,t.length),allText:t}}caretPositionWithDocumentInfoForContenteditable(){let e=this.window.getSelection().getRangeAt(0),t=e.cloneRange();t.setStart(this.element,0),t.setEnd(e.startContainer,e.startOffset);let n=this.captureRangeText(t),i=e.cloneRange();i.selectNodeContents(this.element),i.setStart(e.startContainer,e.startOffset);let o=this.captureRangeText(i);return{leftText:n,selectionStart:n.length,rightText:o,allText:n+o}}caretPositionWithDocumentInfoForAceEditor(){let e=this.element.getValue(),t=this.element.getCursorPosition(),n=t.row,i=t.column;return this.caretPositionWithDocumentInfoForValueRowAndColumn(e,n,i)}caretPositionWithDocumentInfoForCodeMirror(){let e=this.element.getValue(),t=this.element.getCursor(!0),n=t.line,i=t.ch;return this.caretPositionWithDocumentInfoForValueRowAndColumn(e,n,i)}caretPositionWithDocumentInfoForValueRowAndColumn(e,t,n){let i=[],o=[];e.split(/\r?\n/).forEach((function(e,r){r<t?i.push(e):r===t?(i.push(e.slice(0,n)),o.push(e.slice(n,e.length))):r>t&&o.push(e)}));let r=i.join("\n"),s=o.join("\n");return{leftText:r,selectionStart:r.length,rightText:s,allText:r+s}}captureRangeText(e){let t=e.cloneContents(),n=this.document.createElement("div");n.setAttribute("style","position: absolute; left: -10000px; top: -10000px"),n.setAttribute("contenteditable","true"),n.appendChild(t),this.document.body.appendChild(n);let i=n.innerText;return n.remove(),i}getTextAreaOrInputUnderlinePosition(e,t,n){let i=null!==this.window.mozInnerScreenX,o=this.document.createElement("div");o.id="input-textarea-caret-position-mirror-div",this.document.body.appendChild(o);let r=o.style,s=this.window.getComputedStyle?getComputedStyle(e):e.currentStyle;r.whiteSpace="pre-wrap","INPUT"!==e.nodeName&&(r.wordWrap="break-word"),r.position="absolute",r.visibility="hidden",["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"].forEach(e=>{r[e]=s[e]}),i?(r.width=`${parseInt(s.width)-2}px`,e.scrollHeight>parseInt(s.height)&&(r.overflowY="scroll")):r.overflow="hidden",o.textContent=e.value.substring(0,t),"INPUT"===e.nodeName&&(o.textContent=o.textContent.replace(/\s/g," "));let l=this.document.createElement("span");l.textContent=e.value.substring(t)||".",o.appendChild(l);let a=e.getBoundingClientRect(),h=this.document.documentElement,d=(this.window.pageXOffset||h.scrollLeft)-(h.clientLeft||0),c=(this.window.pageYOffset||h.scrollTop)-(h.clientTop||0),u=0,g=0;u=a.top,g=a.left;let m={top:u+c+l.offsetTop+parseInt(s.borderTopWidth)+parseInt(s.fontSize)-e.scrollTop,left:g+d+l.offsetLeft+parseInt(s.borderLeftWidth)};return this.document.body.removeChild(o),m}getContentEditableCaretPosition(e){let t,n,i=`sel_${(new Date).getTime()}_${Math.random().toString().substr(2)}`,o=this.window.getSelection(),r=o.getRangeAt(0);n=this.document.createRange(),n.setStart(o.anchorNode,e),n.setEnd(o.anchorNode,e),n.collapse(!1),t=this.document.createElement("span"),t.id=i,t.appendChild(this.document.createTextNode("\ufeff")),n.insertNode(t),o.removeAllRanges(),o.addRange(r);let s=t.getBoundingClientRect(),l=this.document.documentElement,a=(this.window.pageXOffset||l.scrollLeft)-(l.clientLeft||0),h=(this.window.pageYOffset||l.scrollTop)-(l.clientTop||0),d=0,c=0;d=s.left,c=s.top;let u={left:d+a,top:c+t.offsetHeight+h};return t.parentNode.removeChild(t),u}}exports.BoundElement=BoundElement;