"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const{DropkiqEngine:DropkiqEngine}=require("dropkiq"),BoundElement_1=require("./BoundElement"),tippy_js_1=require("tippy.js");var ColumnType;!function(e){e.Boolean="ColumnTypes::Boolean",e.DateTime="ColumnTypes::DateTime",e.HasMany="ColumnTypes::HasMany",e.HasOne="ColumnTypes::HasOne",e.Numeric="ColumnTypes::Numeric",e.String="ColumnTypes::String",e.Text="ColumnTypes::Text",e.YAML="ColumnTypes::YAML"}(ColumnType||(ColumnType={}));class DropkiqUI{constructor(e,t,i,s,n="",o={}){this.schema=t,this.context=i,this.scope=s,this.licenseKey=n,this.options=o,this.showPreviews="function"==typeof o.showPreviews?o.showPreviews:()=>!0,this.showHints="function"==typeof o.showHints?o.showHints:()=>!0,this.suggestionFilter="function"==typeof o.suggestionFilter?o.suggestionFilter:()=>{},this.onRender="function"==typeof o.onRender?o.onRender:()=>{},this.iframe=o.iframe,this.iframe?(this.window=this.iframe.contentWindow,this.document=this.window.document):(this.window=window,this.document=document),this.element=e,this.window.dropkiqUIInstances||(this.window.dropkiqUIInstances={});let r=this.window.dropkiqUIInstances[this.element];if(r)return r;this.window.dropkiqUIInstances[this.element]=this,this.isCodeMirror="object"==typeof this.element.doc,this.isAceEditor="object"==typeof this.element.renderer,this.boundElement=new BoundElement_1.BoundElement(this.element,this.window,this.document),this.dropkiqEngine=new DropkiqEngine("",0,t,i,s,this.licenseKey,{suggestionFilter:this.suggestionFilter}),this.suggestionsArray=[],this.result={},this.caretOffset={},this.pathSchema=[],this.$poweredByDropkiq=document.createElement("div"),this.$poweredByDropkiq.style.display="none",this.$poweredByDropkiq.style.padding="5px",this.$poweredByDropkiq.style.height="24px",this.$poweredByDropkiq.style.color="#666666",this.$poweredByDropkiq.style["font-size"]="10px",this.$poweredByDropkiq.style.background="rgba(240,240,240,0.9)",this.$poweredByDropkiq.style["text-align"]="right";let l=document.createTextNode("Powered by"),h=document.createElement("img");h.setAttribute("src","https://app.dropkiq.com/plugin/dropkiq-sm.png"),h.style.width="48px",h.style.height="10px",h.style["margin-left"]="3px",this.$poweredByDropkiq.appendChild(l),this.$poweredByDropkiq.appendChild(h),this.$paywall=document.createElement("div"),this.$paywall.style["font-size"]="14px",this.$paywall.style.padding="10px",this.$paywall.style.color="#666666",this.$paywall.display="none",this.$ul=document.createElement("ul"),this.$header=document.createElement("div"),this.$header.setAttribute("class","dropkiq-header"),this.$div=document.createElement("div"),this.$div.setAttribute("id","dropkiq-autosuggest-menu"),this.$div.appendChild(this.$header),this.$div.appendChild(this.$ul),this.$div.appendChild(this.$paywall),this.$div.appendChild(this.$poweredByDropkiq),document.body.appendChild(this.$div);let a=this;a.documentCallback=function(){a.closeMenu()};let d=function(){a.closeMenu()},u=function(e){if(a.suggestionsArray.length){let t;switch(e.keyCode){case 27:return a.closeMenu(),e.preventDefault(),!1;case 38:return a.scrollToPrevious(),e.preventDefault(),!1;case 40:return a.scrollToNext(),e.preventDefault(),!1;case 9:case 13:return t=a.suggestionsArray.find((function(e){return e.active})),a.insertSuggestion(t),e.preventDefault(),!1}}setTimeout((function(){let t=a.boundElement.caretPositionWithDocumentInfo(),i=t.selectionStart,s=t.leftText,n=t.rightText,o=s.slice(-2);if(219!=e.keyCode||!e.shiftKey||"{"!=o[1]&&"{"!=o){if(53==e.keyCode&&e.shiftKey&&"{%"==o&&/^(\s+)?\}(.+)?/.test(n)){let e=a.boundElement.insertTextAtCaret("%");a.boundElement.setCaretPosition(i,0,0,e,""),a.element.focus()}}else{let e=a.boundElement.insertTextAtCaret("}");a.boundElement.setCaretPosition(i,0,0,e,""),a.element.focus()}}),25),c(e)},c=function(e){"function"==typeof e.stopImmediatePropagation&&e.stopImmediatePropagation(),setTimeout((function(){a.findResults.apply(a)}),25)},p=function(e){let t=a.window.getSelection().getRangeAt(0);a.boundElement.setExpiringCachedOnBlurRange(t)};this.isCodeMirror?(this.element.on("keydown",(function(e,t){u(t)})),this.element.on("mousedown",(function(e,t){c(t)})),this.element.on("focus",(function(e,t){c(t)})),this.element.on("blur",(function(e,t){p()})),this.element.on("scroll",(function(e,t){d()}))):this.isAceEditor?(this.element.textInput.getElement().addEventListener("keydown",u),this.element.on("click",c),this.element.on("focus",c),this.element.on("blur",p),this.element.session.on("changeScrollTop",d),this.element.session.on("changeScrollLeft",d)):(this.element.addEventListener("keydown",u),this.element.addEventListener("click",c),this.element.addEventListener("focus",c),this.element.addEventListener("blur",p),this.element.addEventListener("scroll",d))}updateScope(e){this.scope=e,this.dropkiqEngine.updateScope(this.scope)}registerFilter(e,t,i,s,n){this.dropkiqEngine.registerFilter(e,t,i,s,n)}menuIsOpen(){return this.suggestionsArray.length>0}closeMenu(){this.removeDocumentEventListeners(),this.suggestionsArray=[],this.renderSuggestions()}removeDocumentEventListeners(){document.removeEventListener("click",this.documentCallback),this.document&&this.document!==document&&this.document.removeEventListener("click",this.documentCallback)}renderSuggestions(){let e,t=this.result.prefix;if(this.$paywall.innerHTML="",this.$paywall.style.display="none",this.$header.innerHTML="",this.$header.style.display="none",this.$poweredByDropkiq.style.display="none",this.dropkiqEngine.authorizer.authorized()||(this.$poweredByDropkiq.style.display="block"),this.pathSchema&&(e=this.pathSchema[this.pathSchema.length-1]),e&&"ColumnTypes::HasOne"===e.type){let t="https://app.dropkiq.com/plugin/object.png",i=document.createElement("img");i.setAttribute("src",t),i.setAttribute("class","icon"),i.setAttribute("width","16px"),i.setAttribute("height","16px");let s=document.createElement("span");s.textContent=e.name,this.$header.appendChild(i),this.$header.appendChild(s),this.$header.style.display="block"}this.$div.style.top=`${this.caretOffset.top}px`,this.$div.style.left=`${this.caretOffset.left}px`,this.suggestionsArray.length?this.$div.style.display="block":this.$div.style.display="none",this.$ul.innerHTML="";let i=this;this.suggestionsArray.forEach((function(e){let s=document.createElement("li"),n=e.iconImageURLForSuggestion,o=document.createElement("img");o.setAttribute("src",n),o.setAttribute("class","icon"),o.setAttribute("width","16px"),o.setAttribute("height","16px");let r=document.createElement("div");r.setAttribute("class","first-line");let l=document.createElement("div");l.setAttribute("class","extra");let h=document.createElement("span"),a=document.createElement("img");if(a.setAttribute("class","right-arrow"),a.setAttribute("src","https://app.dropkiq.com/plugin/next-level.png"),r.appendChild(o),r.appendChild(a),t){let i=document.createElement("strong");i.textContent=t;let s=e.name;h.textContent=s.slice(t.length,s.length),r.appendChild(i)}else h.textContent=e.name;if(r.appendChild(h),s.appendChild(r),s.setAttribute("title",i.suggestionTitleText(e)),e.hint&&i.showHints()){let t=document.createElement("div");t.setAttribute("class","hint-icon"),t.setAttribute("data-tippy-content",e.hint),t.setAttribute("title","");let i="https://app.dropkiq.com/plugin/question-circle.png",n=document.createElement("img");n.setAttribute("src",i),t.appendChild(n),s.appendChild(t)}if(e.preview&&i.showPreviews()){let t=document.createElement("p");t.textContent="OUTPUT";let i=document.createElement("samp");i.textContent=e.preview,l.appendChild(t),l.appendChild(i),s.appendChild(l)}e.active&&s.classList.add("active"),i.$ul.appendChild(s),s.addEventListener("click",(function(t){i.insertSuggestion(e)}))}));let s=this.$ul.querySelector(".active");if(s&&(this.$ul.scrollTop=s.offsetTop-50),e&&"ColumnTypes::HasOne"===e.type&&!this.dropkiqEngine.authorizer.authorized()){this.$ul.innerHTML="",this.$paywall.style.display="block";let e=document.createElement("p"),t=this.suggestionsArray[0];t&&(e.textContent=t.hint),this.$paywall.appendChild(e);let i=document.createElement("p"),s=document.createElement("a");s.textContent="Purchase to unlock",s.setAttribute("href","http://dropkiq.com"),i.appendChild(s),this.$paywall.appendChild(i)}i.removeDocumentEventListeners(),setTimeout((function(){document.addEventListener("click",i.documentCallback),i.document&&i.document!==document&&i.document.addEventListener("click",i.documentCallback)}),100),tippy_js_1.default(".hint-icon")}findResults(){let e=this.boundElement.caretPositionWithDocumentInfo();if(this.caretOffset=this.boundElement.getCaretPosition(),this.iframe){var t=this.iframe.getBoundingClientRect();this.caretOffset.top=this.caretOffset.top+t.top,this.caretOffset.left=this.caretOffset.left+t.left}try{this.result=this.dropkiqEngine.update(e.allText,e.selectionStart)}catch(e){if(this.closeMenu(),"ParseError"===e.name)return!1;if("RenderError"===e.name)return!1;throw e}this.onRender(this.result.renderedDocument),this.pathSchema=this.result.pathSchema;this.suggestionsArray=this.result.suggestionsArray||[],this.suggestionsArray.length>0&&(this.suggestionsArray=this.suggestionsArray.sort((e,t)=>e.name>t.name?1:-1),this.suggestionsArray[0].active=!0),this.renderSuggestions()}insertSuggestion(e){let t,i,s=this.result.prefix;"ColumnTypes::Filter"===e.type?(i=this.boundElement.caretPositionWithDocumentInfo(),t=e.insertionTemplate):t=e.name;let n=t.slice(s.length,t.length);"ColumnTypes::HasOne"===e.type&&(n+=".");let o=this.boundElement.insertTextAtCaret(n);if("ColumnTypes::Filter"===e.type){let t=e.selectRange[0],n=e.selectRange[1];this.boundElement.setCaretPosition(i.selectionStart,t,n,o,s)}this.boundElement.setFocus(),this.closeMenu();let r=this;setTimeout((function(){r.findResults.apply(r)}),25)}scrollToNext(){let e=this.suggestionsArray.find((function(e,t){return e.active})),t=this.suggestionsArray.indexOf(e);this.suggestionsArray[t].active=!1,this.suggestionsArray[t+1]?this.suggestionsArray[t+1].active=!0:this.suggestionsArray[0].active=!0,this.renderSuggestions()}scrollToPrevious(){let e=this.suggestionsArray.find((function(e,t){return e.active})),t=this.suggestionsArray.indexOf(e);this.suggestionsArray[t].active=!1,this.suggestionsArray[t-1]?this.suggestionsArray[t-1].active=!0:this.suggestionsArray[this.suggestionsArray.length-1].active=!0,this.renderSuggestions()}suggestionTitleText(e){let t=[e.name];return e.preview&&t.push(`**OUTPUT** ${e.preview}`),e.hint&&t.push(`**HINT** ${e.hint}`),t.join(" ")}}exports.DropkiqUI=DropkiqUI;